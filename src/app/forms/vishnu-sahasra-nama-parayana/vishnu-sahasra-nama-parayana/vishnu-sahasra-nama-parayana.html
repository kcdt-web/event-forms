<!-- Alert for errors -->
<div *ngIf="submissionError" class="alert alert-danger">
    {{ submissionError }}
</div>
<!-- Success message -->
@if (registrationSuccess) {
<div class="alert p-4">
    <h1>Registration Submitted Successfully!</h1>
    <p>All future updates and important information regarding the event will be sent to the mobile number you provided
        at the time of registration.</p>
    <p>We look forward to your participation.</p>
    <a class="btn btn-primary" href="/home">Back to home</a>
</div>
} @else {
<h1 class="mb-4">Vishnu Sahasra Nama Parayana</h1>

<form [formGroup]="searchForm" novalidate>

    @if (!mainParticipant) {
    <fieldset class="border rounded p-4 mb-4">
        <legend class="h5 m-0 mb-4">Search your registration</legend>
        <div class="mb-4">
            <div class="d-flex flex-column flex-md-row gap-2">

                <!-- Desktop country select -->
                <p-floatlabel *ngIf="!isMobile" variant="on">
                    <p-select inputId="country_code" [options]="countriesList" optionLabel="displayName" filter
                        filterBy="displayName" fluid formControlName="country_code" required appendTo="self">
                    </p-select>
                    <label for="country_code">Country Code <span class="text-danger">*</span></label>
                </p-floatlabel>

                <!-- Mobile country select -->
                <div *ngIf="isMobile" class="flex-fill">
                    <label class="form-label fw-semibold mb-2 d-block">Country Code <span
                            class="text-danger">*</span></label>
                    <select class="form-select form-select-lg mb-2" formControlName="country_code" required>
                        <option *ngFor="let country of countriesList" [ngValue]="country">
                            {{ country.displayName }}
                        </option>
                    </select>
                </div>

                <!-- Mobile number input -->
                <p-floatlabel variant="on" class="flex-fill">
                    <p-inputnumber mode="decimal" inputId="mobile_number" [useGrouping]="false" fluid="true"
                        [inputStyleClass]="
                            (
                            searchForm.get('mobile_number')?.invalid &&
                            searchForm.get('mobile_number')?.touched
                            ) || invalidSearchNumber
                            ? 'p-invalid'
                            : ''
                        " [minlength]="mobileNumberMinLength" [maxlength]="mobileNumberMaxLength"
                        formControlName="mobile_number" required>
                    </p-inputnumber>
                    <label for="mobile_number">Mobile number (WhatsApp) <span class="text-danger">*</span></label>
                </p-floatlabel>

            </div>

            <div *ngIf="(searchForm.get('mobile_number')?.touched &&
                searchForm.get('mobile_number')?.invalid) ||
                invalidSearchNumber
            " class="form-text text-danger">
                {{ mobileNumberErrorMsg || 'Mobile number is required.' }}
            </div>
            <div class="form-text">
                Use the mobile number you provided during registration.
            </div>
        </div>

        <!-- Search Button -->
        <p-button type="button" [loading]="searching" [disabled]="searching"
            label="{{ searching ? 'Searching…' : 'Search' }}" (onClick)="searchRegistration()">
        </p-button>

    </fieldset>
    }

    @if (mainParticipant) {
    <fieldset class="border rounded p-4 mb-4">
        <legend class="h5 m-0 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <span>Search Results</span>
                <p-button type="button" label="New Search" link styleClass="p-0 px-1" (onClick)="resetForm()">
                </p-button>
            </div>
        </legend>

        @if (!mainParticipant.status){
        <div class="alert alert-danger">
            You have withdrawn your registration. To participate in the event, register again along with your
            accompanying participants, or reach out to us at <a href="tel:+919494877171">9494877171</a>.
        </div>
        }

        <p-panel class="mb-4" showHeader="false">
            <h4 class="mb-4">{{mainParticipant.full_name}}</h4>

            <div class="mb-4">
                <p class="text-muted small m-0 mb-1">Registration Status</p>
                <p class="fw-semibold m-0">
                    @if (mainParticipant.status) {
                    <p-tag severity="success" value="Active" />
                    } @else {
                    <p-tag severity="danger" value="Withdrawn" />
                    }
                </p>
            </div>

            <div class="mb-4">
                <p class="text-muted small m-0 mb-1">Registered On</p>
                <p class="fw-semibold m-0">{{mainParticipant.registered_on | date:'medium':'local'}}</p>
            </div>

            <div [class]="mainParticipant.status ? 'mb-4' : ''">
                <p class="text-muted small m-0 mb-1">Accompanying Participants</p>
                <p class="fw-semibold m-0">{{accompanyingParticipant.length || '0'}} Participants</p>
            </div>

            <hr />

            <div class="mb-4">
                <div class="my-4">
                    <h5>Which day(s) will you be attending the Vishnu Sahasra Nama Parayana? <span
                            class="text-danger">*</span></h5>
                    <div class="d-flex text-muted small gap-2 align-items-center mb-4">
                        <i class="pi pi-info-circle"></i>
                        <span>Select at least one 1-hour slot from the options below.</span>
                    </div>
                </div>
                <div [formGroup]="primarySlots">
                    <ng-container *ngTemplateOutlet="slotSelector; context: { form: primarySlots }">
                    </ng-container>
                </div>
                <div *ngIf="hasSlotError(primarySlots)" class="text-danger small mt-2">
                    Select at least one time slot for Day 1 or Day 2.
                </div>
            </div>

            <div>
                <label class="fw-semibold mb-2 d-block">
                    Apply these time slots to all accompanying participants?
                </label>

                <p-selectbutton [options]="yesNoOptions" [formControl]="applyToAllAccompanying" optionLabel="label"
                    optionValue="value">
                </p-selectbutton>
            </div>
        </p-panel>

        <div *ngIf="!applyToAllAccompanying.value">
            <h6 class="m-0 mb-2">Participant details</h6>
            <div *ngFor="let accomp of accompanyingParticipant; let i = index">
                <p-panel [toggleable]="true" class="mb-4">
                    <ng-template #header>
                        <div class="d-flex flex-column py-2">
                            <div class="fw-semibold">{{ accomp.full_name }}</div>
                            <div class="text-muted small">Accompanying Participant {{ i + 1 }}</div>
                        </div>
                    </ng-template>
                    <div [formGroup]="accompanyingSlots[i]">
                        <div class="mb-3">
                            <label class="fw-semibold mb-2 d-block">
                                Use same time slots?
                            </label>

                            <p-selectbutton formControlName="copyFromPrimary" [options]="yesNoOptions"
                                optionLabel="label" optionValue="value">
                            </p-selectbutton>
                        </div>
                        <!-- Slot selector -->
                        <div class="mt-3" [class.opacity-50]="accompanyingSlots[i].get('copyFromPrimary')?.value">
                            <ng-container *ngTemplateOutlet="slotSelector; context: { form: accompanyingSlots[i] }">
                            </ng-container>
                        </div>
                        <div *ngIf="hasSlotError(accompanyingSlots[i])" class="text-danger small mt-2">
                            Select at least one time slot for this participant.
                        </div>
                    </div>
                </p-panel>
            </div>
        </div>
    </fieldset>

    <!-- Submit Button -->
    <p-button type="button" label="{{ saving ? 'Saving…' : 'Save Slots' }}" [loading]="saving" [disabled]="saving"
        (onClick)="submitSlots()">
    </p-button>
    }

</form>
}

<ng-template #slotSelector let-form="form">
    <div [formGroup]="form">
        <div formGroupName="activities">
            <div class="mb-4">
                <p class="text-muted small m-0 mb-1">Day 1 - 14 March 2026</p>
                <p-selectbutton id="activities-day1" [options]="day1Slots" multiple="true" styleClass="border rounded"
                    class="d-flex flex-column flex-md-row flex-md-wrap gap-2 activities" formControlName="day1"
                    optionLabel="slot_time" optionValue="id" optionDisabled="disabled"
                    [ngClass]="{'p-invalid': form.get('activities')?.errors?.['noDaysSelected'] && (form.get('activities')?.touched || form.get('activities')?.dirty)}">
                    <ng-template #item let-item>
                        <div class="d-flex flex-column justify-content-center align-items-center gap-2 w-100">
                            <div class="fw-semibold">{{item.slot_time}}</div>
                            @if (!item.disabled){
                            <div class="small fw-regular" [ngClass]="
                                            item.disabled ? 'text-muted' :
                                            item.remaining < 2 ? 'text-danger' :
                                            item.remaining < 4 ? 'text-warning' :
                                            'text-success'
                                            ">
                                {{item.remaining}} available</div>
                            } @else {
                            @if (item.remaining !== 0) {
                            <div class="small fw-regular text-muted">{{item.remaining}} available</div>
                            } @else {
                            <div class="small fw-regular text-muted">Filled</div>}
                            }
                        </div>
                    </ng-template>
                </p-selectbutton>
            </div>
            <div>
                <p class="text-muted small m-0 mb-1">Day 2 - 15 March 2026</p>
                <p-selectbutton id="activities-day2" [options]="day2Slots" multiple="true" styleClass="border rounded"
                    class="d-flex flex-column flex-md-row flex-md-wrap gap-2 activities" formControlName="day2"
                    optionLabel="slot_time" optionValue="id" optionDisabled="disabled"
                    [ngClass]="{'p-invalid': form.get('activities')?.errors?.['noDaysSelected'] && (form.get('activities')?.touched || form.get('activities')?.dirty)}">
                    <ng-template #item let-item>
                        <div class="d-flex flex-column justify-content-center align-items-center gap-2 w-100">
                            <div class="fw-semibold">{{item.slot_time}}</div>
                            @if (!item.disabled){
                            <div class="small fw-regular" [ngClass]="
                                            item.disabled ? 'text-muted' :
                                            item.remaining < 2 ? 'text-danger' :
                                            item.remaining < 4 ? 'text-warning' :
                                            'text-success'
                                            ">
                                {{item.remaining}} available</div>
                            } @else {
                            @if (item.remaining !== 0) {
                            <div class="small fw-regular text-muted">{{item.remaining}} available</div>
                            } @else {
                            <div class="small fw-regular text-muted">Filled</div>}
                            }
                        </div>
                    </ng-template>
                </p-selectbutton>
            </div>
        </div>
    </div>
</ng-template>