<!-- Alert for errors -->
<div *ngIf="submissionError" class="alert alert-danger">
    {{ submissionError }}
</div>
<!-- Success message -->
@if (registrationSuccess) {
@if (noSlotsAvailable) {
<div class="alert p-4">
    <h1>You're Now on the Waitlist!</h1>
    <p>You've been successfully added to our waitlist. All current slots are filled, but we'll contact you at the mobile
        number you provided as soon as a spot becomes available.</p>
    <a class="btn btn-primary" href="/varanasi-event/">
        Back to event details
    </a>
</div>
} @else {
<div class="alert p-4 print-area">
    <h1 class="mb-3">Slot Saved Successfully!</h1>
    <p>Your slot for the <em>Gayathri Havanam</em> has been reserved. All further updates and important
        details will be communicated to your registered mobile number.
    </p>

    <hr class="my-4" />
    <div>
        <h5 class="mb-3">Participant Slot Summary</h5>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Participant Name</th>
                        <th>Day 1 (14 March 2026)</th>
                        <th>Day 2 (15 March 2026)</th>
                        <th>Day 3 (16 March 2026)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let row of slotSummary">
                        <td class="fw-semibold">{{ row.full_name }}</td>
                        <td>{{ row.day1 }}</td>
                        <td>{{ row.day2 }}</td>
                        <td>{{ row.day3 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    @if (noSlotsAvailable) {
    <div class="alert alert-danger">Slot changes are temporarily unavailable because we’re currently at full
        capacity.</div>
    }
    @else {
    <p>
        To make changes, please select another available slot and save your updates. Please note that slots are subject
        to availability.
    </p>
    }

    <div class="confirmation-actions">
        <div class="d-flex gap-3 mb-5 flex-wrap">
            <p-button type="button" label="Print Confirmation" (onClick)="printSummary()">
            </p-button>

            <p-button type="button" [loading]="saving" [disabled]="noSlotsAvailable" label="Change Slot"
                (onClick)="confirmChangeSlots()">
            </p-button>

            <p-button type="button" severity="danger" label="Withdraw" [loading]="withdrawing"
                (onClick)="confirmWithdraw()">
            </p-button>
        </div>

        <a href="/varanasi-event/">
            Back to event details
        </a>
    </div>
</div>
}
} @else {
<h1 class="mb-4">Reserve Your Spot for Gayathri Havanam</h1>
<div class="alert alert-primary">
    <ul class="m-0 p-0 px-3">
        <li class="mb-2">Performing Gayatri Japam daily after Sandhyavandanam,with a sankalpa for universal peace, is
            required and
            mandatory for registration as part of the Shanti Homam.</li>
        <li class="m-0">If you haven't started yet, begin today. For instructions, call <a
                href="tel:+919494877171">9494877171</a>.</li>
    </ul>
</div>
<p>We kindly request all participants to register in advance and select the time slot(s) they wish to attend. This will
    help us organize the Parayana smoothly.</p>

<form [formGroup]="searchForm" novalidate>

    @if (!mainParticipant) {
    <fieldset class="border rounded p-4 mb-4">
        <legend class="h5 m-0 mb-4">Search your registration</legend>

        <!-- KCDT Member ID -->
        <div class="mb-4">
            <p-floatlabel variant="on">
                <p-inputnumber mode="decimal" inputId="member_id" [useGrouping]="false" inputStyleClass="form-control"
                    fluid="true" formControlName="kcdt_member_id"></p-inputnumber>
                <label for="member_id" class="form-label d-block">KCDT Member ID <span
                        class="text-danger">*</span></label>
            </p-floatlabel>
            <div *ngIf="searchForm.get('kcdt_member_id')?.touched && searchForm.get('kcdt_member_id')?.invalid"
                class="form-text text-danger">
                KCDT Member ID is required.
            </div>
        </div>

        <div class="mb-4">
            <div class="d-flex flex-column flex-md-row gap-2">

                <!-- Desktop country select -->
                <p-floatlabel *ngIf="!isMobile" variant="on">
                    <p-select inputId="country_code" [options]="countriesList" optionLabel="displayName" filter
                        filterBy="displayName" fluid formControlName="country_code" required appendTo="self">
                    </p-select>
                    <label for="country_code">Country Code <span class="text-danger">*</span></label>
                </p-floatlabel>

                <!-- Mobile country select -->
                <div *ngIf="isMobile" class="flex-fill">
                    <label class="form-label fw-semibold mb-2 d-block">Country Code <span
                            class="text-danger">*</span></label>
                    <select class="form-select form-select-lg mb-2" formControlName="country_code" required>
                        <option *ngFor="let country of countriesList" [ngValue]="country">
                            {{ country.displayName }}
                        </option>
                    </select>
                </div>

                <!-- Mobile number input -->
                <p-floatlabel variant="on" class="flex-fill">
                    <p-inputnumber mode="decimal" inputId="mobile_number" [useGrouping]="false" fluid="true"
                        [inputStyleClass]="
                            (
                            searchForm.get('mobile_number')?.invalid &&
                            searchForm.get('mobile_number')?.touched
                            ) || invalidSearchNumber
                            ? 'p-invalid'
                            : ''
                        " [minlength]="mobileNumberMinLength" [maxlength]="mobileNumberMaxLength"
                        formControlName="mobile_number" required>
                    </p-inputnumber>
                    <label for="mobile_number">Mobile number (WhatsApp) <span class="text-danger">*</span></label>
                </p-floatlabel>

            </div>

            <div *ngIf="(searchForm.get('mobile_number')?.touched &&
                searchForm.get('mobile_number')?.invalid) ||
                invalidSearchNumber
            " class="form-text text-danger">
                {{ mobileNumberErrorMsg || 'Mobile number is required.' }}
            </div>
            <div class="form-text">
                Use the mobile number you provided during registration.
            </div>
        </div>

        <!-- Search Button -->
        <p-button type="button" [loading]="searching" [disabled]="searching"
            label="{{ searching ? 'Searching…' : 'Search' }}" (onClick)="searchRegistration()">
        </p-button>

    </fieldset>
    }

    @if (mainParticipant) {
    <fieldset class="border rounded p-4 mb-4">
        <legend class="h5 m-0 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <span>Search Results</span>
                <p-button type="button" label="New Search" link styleClass="p-0 px-1" (onClick)="resetForm()">
                </p-button>
            </div>
        </legend>

        @if (!mainParticipant.status){
        <div class="alert alert-danger">
            You have withdrawn your registration. For further clarification, please reach out to us at <a
                href="tel:+919494877171">9494877171</a>.
        </div>
        }

        <p-panel class="mb-4" showHeader="false">
            <h4 class="m-0 mb-4">{{mainParticipant.full_name}}</h4>
            <div class="mb-4">
                <p class="text-muted small m-0 mb-1">Registration Status</p>
                <p class="fw-semibold m-0">
                    @if (mainParticipant.status) {
                    <p-tag severity="success" value="Active" />
                    } @else {
                    <p-tag severity="danger" value="Withdrawn" />
                    }
                </p>
            </div>
            <div class="mb-4">
                <p class="text-muted small m-0 mb-1">Registered On</p>
                <p class="fw-semibold m-0">{{mainParticipant.registered_on | date:'medium':'local'}}</p>
            </div>

            @if (mainParticipant.status && !hasExistingGh){
            <hr />
            <div class="mb-4">
                <div class="my-4">
                    <h5>Which day(s) will you be attending the Gayathri Havanam? <span class="text-danger">*</span></h5>
                    <div class="d-flex text-muted small gap-2 align-items-center mb-4">
                        <i class="pi pi-info-circle"></i>
                        <span>Select at least one 1-hour slot from the options below. You can choose up to <span
                                class="fw-semibold">4</span> slots per day, with
                            a maximum of <span class="fw-semibold">2</span> consecutive slots.</span>
                    </div>
                </div>

                <div class="alert alert-info"
                    *ngIf="(getSelectedCount('day1') <= 4 || getSelectedCount('day2') <= 4 || getSelectedCount('day3') <= 4) && (hasConsecutiveOrDisabledInBetween('day1') || hasConsecutiveOrDisabledInBetween('day2') || hasConsecutiveOrDisabledInBetween('day3'))">
                    Some slots are disabled based on your selection pattern. You can choose up to 4 slots per day,
                    with a maximum of 2 consecutive slots.
                </div>

                <div [formGroup]="primarySlots">
                    <ng-container *ngTemplateOutlet="slotSelector; context: { form: primarySlots }">
                    </ng-container>
                </div>
                <div *ngIf="hasSlotError(primarySlots)" class="text-danger small mt-2">
                    Select at least one time slot for Day 1 or Day 2.
                </div>
            </div>
            }
        </p-panel>

        @if (mainParticipant.status && !hasExistingGh){
        <!-- Submit Button -->
        <p-button type="button" [label]="saving ? 'Saving…' : (noSlotsAvailable ? 'Join waitlist' : 'Save Slots')"
            [loading]="saving" [disabled]="saving" (onClick)="submitSlots()">
        </p-button>
        }

        @if (hasExistingGh) {
        <p-panel class="mb-4" showHeader="false">
            <h4 class="m-0 mb-3">Your Gayathri Havanam Slots</h4>
            @if (noSlotsAvailable) {
            <div class="alert alert-danger">Slot changes are temporarily unavailable because we’re currently at full
                capacity.</div>
            }
            <p>You have already registered. Below are your confirmed selections. </p>
            <div class="table-responsive mt-3">
                <table class="table table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Participant Name</th>
                            <th>Day 1 (14 March 2026)</th>
                            <th>Day 2 (15 March 2026)</th>
                            <th>Day 2 (16 March 2026)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let row of ghSummary">
                            <td class="fw-semibold">{{ row.full_name }}</td>
                            <td>{{ row.day1 }}</td>
                            <td>{{ row.day2 }}</td>
                            <td>{{ row.day3 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="confirmation-actions">
                <div class="d-flex gap-3 flex-wrap">
                    <p-button type="button" label="Print Confirmation" (onClick)="printSummary()">
                    </p-button>

                    <p-button type="button" [loading]="saving" [disabled]="noSlotsAvailable" label="Change Slot"
                        (onClick)="confirmChangeSlots()">
                    </p-button>

                    <p-button type="button" severity="danger" label="Withdraw" [loading]="withdrawing"
                        (onClick)="confirmWithdraw()">
                    </p-button>
                </div>
            </div>
        </p-panel>
        }
    </fieldset>
    }
</form>
}

<ng-template #slotSelector let-form="form">
    @if (!noSlotsAvailable) {
    <div class="slot-section" [formGroup]="form">
        <div formGroupName="activities">
            <div class="mb-4">
                <p class="text-muted small m-0 mb-2 fw-semibold">Day 1 - 14 March 2026</p>
                <p-selectbutton id="activities-day1" [options]="day1Slots" multiple="true" styleClass="border rounded"
                    class="d-flex flex-column flex-md-row flex-md-wrap gap-2 activities" formControlName="day1"
                    optionLabel="slot_time" optionValue="id" optionDisabled="disabled" [ngClass]="{
                    'p-invalid':
                        form.get('activities')?.errors?.['noDaysSelected'] &&
                        (
                        form.get('activities')?.touched ||
                        form.get('activities')?.dirty ||
                        slotsSubmitted
                        )
                    }">
                    <ng-template #item let-item>
                        <div class="d-flex flex-column justify-content-center align-items-center gap-2 w-100">
                            <div class="fw-semibold">{{item.slot_time}}</div>
                            @if (!item.disabled){
                            <div class="small fw-regular" [ngClass]="
                                            item.disabled ? 'text-muted' :
                                            item.remaining < 2 ? 'text-danger' :
                                            item.remaining < 4 ? 'text-warning' :
                                            'text-success'
                                            ">
                                {{item.remaining}} available</div>
                            } @else {
                            @if (item.remaining !== 0) {
                            <div class="small fw-regular text-muted">{{item.remaining}} available</div>
                            } @else {
                            <div class="small fw-regular text-muted">Filled</div>}
                            }
                        </div>
                    </ng-template>
                </p-selectbutton>
            </div>
            <div class="mb-4">
                <p class="text-muted small m-0 mb-2 fw-semibold">Day 2 - 15 March 2026</p>
                <p-selectbutton id="activities-day2" [options]="day2Slots" multiple="true" styleClass="border rounded"
                    class="d-flex flex-column flex-md-row flex-md-wrap gap-2 activities" formControlName="day2"
                    optionLabel="slot_time" optionValue="id" optionDisabled="disabled" [ngClass]="{
                    'p-invalid':
                        form.get('activities')?.errors?.['noDaysSelected'] &&
                        (
                        form.get('activities')?.touched ||
                        form.get('activities')?.dirty ||
                        slotsSubmitted
                        )
                    }">
                    <ng-template #item let-item>
                        <div class="d-flex flex-column justify-content-center align-items-center gap-2 w-100">
                            <div class="fw-semibold">{{item.slot_time}}</div>
                            @if (!item.disabled){
                            <div class="small fw-regular" [ngClass]="
                                            item.disabled ? 'text-muted' :
                                            item.remaining < 2 ? 'text-danger' :
                                            item.remaining < 4 ? 'text-warning' :
                                            'text-success'
                                            ">
                                {{item.remaining}} available</div>
                            } @else {
                            @if (item.remaining !== 0) {
                            <div class="small fw-regular text-muted">{{item.remaining}} available</div>
                            } @else {
                            <div class="small fw-regular text-muted">Filled</div>}
                            }
                        </div>
                    </ng-template>
                </p-selectbutton>
            </div>
            <div>
                <p class="text-muted small m-0 mb-2 fw-semibold">Day 3 - 16 March 2026</p>
                <p-selectbutton id="activities-day2" [options]="day3Slots" multiple="true" styleClass="border rounded"
                    class="d-flex flex-column flex-md-row flex-md-wrap gap-2 activities" formControlName="day3"
                    optionLabel="slot_time" optionValue="id" optionDisabled="disabled" [ngClass]="{
                    'p-invalid':
                        form.get('activities')?.errors?.['noDaysSelected'] &&
                        (
                        form.get('activities')?.touched ||
                        form.get('activities')?.dirty ||
                        slotsSubmitted
                        )
                    }">
                    <ng-template #item let-item>
                        <div class="d-flex flex-column justify-content-center align-items-center gap-2 w-100">
                            <div class="fw-semibold">{{item.slot_time}}</div>
                            @if (!item.disabled){
                            <div class="small fw-regular" [ngClass]="
                                            item.disabled ? 'text-muted' :
                                            item.remaining < 2 ? 'text-danger' :
                                            item.remaining < 4 ? 'text-warning' :
                                            'text-success'
                                            ">
                                {{item.remaining}} available</div>
                            } @else {
                            @if (item.remaining !== 0) {
                            <div class="small fw-regular text-muted">{{item.remaining}} available</div>
                            } @else {
                            <div class="small fw-regular text-muted">Filled</div>}
                            }
                        </div>
                    </ng-template>
                </p-selectbutton>
            </div>
        </div>
    </div>
    } @else {
    <div class="alert alert-primary m-0">We’re currently at capacity, but availability can change. <span
            class="fw-semibold">Join our
            waitlist</span>, and we’ll notify you right away when a spot becomes available.</div>
    }
</ng-template>